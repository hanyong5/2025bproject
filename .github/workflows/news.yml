name: news collection
on:
  push:
    branches:
      - main
  schedule:
    # ë§¤ì¼ í•œêµ­ ì‹œê°„ ìì •(00:00)ê³¼ ì˜¤ì „ 8ì‹œ(08:00)ì— ìë™ ì‹¤í–‰
    # UTC ê¸°ì¤€: ìì • = 15:00 (ì „ë‚ ), ì˜¤ì „ 8ì‹œ = 23:00 (ì „ë‚ )
    - cron: "0 15 * * *"  # í•œêµ­ ì‹œê°„ ìì • (UTC 15:00)
    - cron: "0 23 * * *"  # í•œêµ­ ì‹œê°„ ì˜¤ì „ 8ì‹œ (UTC 23:00)
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
permissions:
  contents: write
  
jobs:
  collect-news-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘
        run: |
          python newdata.py

      - name: ìˆ˜ì§‘ëœ íŒŒì¼ í™•ì¸
        run: |
          echo "ğŸ“ data í´ë” ë‚´ìš©:"
          ls -lh data/ || echo "data í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤."

      - name: Git ì„¤ì •
        run: |
          git config --global user.name "hanyong5"
          git config --global user.email "hanyong5@naver.com"
          git config --global init.defaultBranch main

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          # ì›ê²© ì €ì¥ì†Œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git fetch origin main
          
          # ë¡œì»¬ ë¸Œëœì¹˜ë¥¼ ì›ê²©ê³¼ ì™„ì „íˆ ë™ê¸°í™” (HEAD ì¶©ëŒ ë°©ì§€)
          git reset --hard origin/main
          git clean -fd
          
          # ë°ì´í„° íŒŒì¼ ì¶”ê°€
          git add data/
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            CURRENT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ“° ë‰´ìŠ¤ ìˆ˜ì§‘: ${CURRENT_DATE}"
            
            # í‘¸ì‹œ ì „ì— ë‹¤ì‹œ ìµœì‹  ìƒíƒœ í™•ì¸
            git fetch origin main
            # ì›ê²©ì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ ìˆìœ¼ë©´ merge (ì¶©ëŒ ì—†ì´)
            if ! git merge --no-edit origin/main; then
              # merge ì‹¤íŒ¨ ì‹œ ì›ê²© ê¸°ì¤€ìœ¼ë¡œ resetí•˜ê³  ë‹¤ì‹œ ì»¤ë°‹
              git reset --hard origin/main
              git add data/
              git commit -m "ğŸ“° ë‰´ìŠ¤ ìˆ˜ì§‘: ${CURRENT_DATE}"
            fi
            
            git push origin main
            echo "âœ… ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
